// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// SUPER ADMIN LEVEL MODELS
// ============================================

model Plan {
  id                     String   @id @default(cuid())
  name                   String // e.g., "Basic", "Pro", "Enterprise"
  maxSpins               Int      @default(1000) // Total spins allowed per month
  maxCampaigns           Int      @default(1)
  campaignDurationDays   Int      @default(30) // How many days a campaign can run
  waIntegrationEnabled   Boolean  @default(true)
  canUseCustomTemplates  Boolean  @default(false)
  allowCustomDomain      Boolean  @default(false) // Gate for custom domain feature
  allowEmbedding         Boolean  @default(false) // Gate for iframe embedding
  allowAnalytics         Boolean  @default(false) // Gate for analytics dashboard
  allowQRCodeGenerator   Boolean  @default(false) // Gate for QR code generation
  allowInventoryTracking Boolean  @default(false) // Gate for prize inventory tracking
  price                  Float? // Monthly subscription price
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  tenants                Tenant[]

  @@index([name])
}

model SubscriptionPlan {
  id       String @id @default(cuid())
  name     String // "Free", "Starter", "Pro", "Enterprise"
  price    Int // in paise (₹0, ₹999, ₹4999, etc.)
  interval String // "MONTHLY", "YEARLY"

  // Campaign limits
  campaignsPerMonth Int @default(1)
  spinsPerCampaign  Int @default(1000)

  // Social media features
  socialMediaEnabled Boolean @default(false)
  maxSocialTasks     Int     @default(0)

  // Feature flags
  customBranding    Boolean @default(false)
  advancedAnalytics Boolean @default(false)

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  tenants Tenant[]

  @@index([name])
  @@index([isActive])
}

model WheelTemplate {
  id           String     @id @default(cuid())
  name         String // e.g., "Classic", "Modern", "Neon"
  thumbnail    String? // URL to preview image
  configSchema Json // Template configuration (colors, styles, etc.)
  componentKey String     @default("Classic") // React component identifier
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  campaigns    Campaign[]

  @@index([isActive])
}

// ============================================
// TENANT LEVEL MODELS
// ============================================

model Tenant {
  id           String  @id @default(cuid())
  name         String // Business name
  slug         String  @unique // Subdomain or path identifier
  contactPhone String? // Contact mobile number
  customDomain String? @unique // e.g., "offer.myshop.com"
  planId       String
  plan         Plan    @relation(fields: [planId], references: [id])

  // Subscription fields
  subscriptionPlanId String?
  subscriptionPlan   SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  subscriptionStatus String            @default("TRIAL") // TRIAL, ACTIVE, CANCELED
  subscriptionStart  DateTime?
  subscriptionEnd    DateTime?

  isActive     Boolean       @default(true)
  waConfig     Json? // Override WhatsApp config: { apiUrl, apiKey, sender }
  
  // Meta API credentials for Connect verification (Premium feature)
  facebookPageId     String?
  facebookToken      String?  @db.Text
  instagramAccountId String?
  instagramToken     String?  @db.Text
  
  // API rate limit tracking
  metaApiUsageHour   Int      @default(0)
  lastApiUsageReset  DateTime @default(now())
  
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  campaigns    Campaign[]
  prizes       Prize[]
  endUsers     EndUser[]
  tenantAdmins TenantAdmin[]
  usage        TenantUsage[]

  @@index([slug])
  @@index([isActive])
  @@index([subscriptionPlanId])
  @@index([subscriptionStatus])
}

model TenantAdmin {
  id        String   @id @default(cuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email     String   @unique
  password  String // Hashed with bcrypt
  name      String
  createdAt DateTime @default(now())

  @@index([tenantId, email])
}

model TenantUsage {
  id       String @id @default(cuid())
  tenantId String
  tenant   Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  month            String // "2026-01" format
  campaignsCreated Int    @default(0)
  spinsUsed        Int    @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, month])
  @@index([tenantId, month])
}

// ============================================
// CAMPAIGN LEVEL MODELS (Tenant-Scoped)
// ============================================

model Campaign {
  id                       String            @id @default(cuid())
  tenantId                 String
  tenant                   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  templateId               String?
  template                 WheelTemplate?    @relation(fields: [templateId], references: [id], onDelete: SetNull)
  name                     String
  description              String?
  logoUrl                  String? // URL for wheel center logo
  supportMobile            String? // Contact number for support
  websiteUrl               String? // Campaign website
  isActive                 Boolean           @default(true)
  isArchived               Boolean           @default(false) // Soft delete flag
  archivedAt               DateTime? // When campaign was archived
  spinLimit                Int               @default(1) // Max spins allowed per user
  spinCooldown             Int               @default(24) // Cooldown in hours
  referralsRequiredForSpin Int               @default(0) // 0 = disabled, N = invite N friends for bonus spin
  startDate                DateTime
  endDate                  DateTime
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt
  
  // Referral rewards (admin sets globally)
  referralsForBonus        Int               @default(5)
  referralBonusSpins       Int               @default(1)
  
  // WhatsApp notification settings
  notificationEnabled       Boolean           @default(true)
  notificationStartHour     Int               @default(9)   // 9 AM
  notificationEndHour       Int               @default(21)  // 9 PM
  sendImmediately           Boolean           @default(false) // Override time window
  
  // Social media features
  socialMediaEnabled        Boolean           @default(false)
  
  // Default spin rewards per action type (JSON: { "VISIT_PAGE": 2, "VISIT_PROFILE": 2, "VIEW_POST": 1, ... })
  defaultSpinRewards        Json?             // e.g., { "VISIT_PAGE": 2, "VISIT_PROFILE": 2, "VIEW_POST": 1, "VIEW_DISCUSSION": 1, "VISIT_TO_SHARE": 1 }
  
  prizes                   Prize[]
  spins                    Spin[]
  socialTasks              SocialMediaTask[]
  landingPage              LandingPage?

  @@index([tenantId, isActive, isArchived])
  @@index([isActive, startDate, endDate])
  @@index([isArchived])
}

model EndUser {
  id                    String                 @id @default(cuid())
  tenantId              String
  tenant                Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  phone                 String
  name                  String?
  email                 String?
  referralCode          String                 @default(cuid())
  referredById          String?
  referredBy            EndUser?               @relation("UserReferrals", fields: [referredById], references: [id])
  referrals             EndUser[]              @relation("UserReferrals")
  successfulReferrals   Int                    @default(0) // Count of referrals who verified & spun
  sharedWins            Int                    @default(0) // Number of times user shared a win
  bonusSpinsEarned      Int                    @default(0) // Total bonus spins earned from sharing
  createdAt             DateTime               @default(now())
  spins                 Spin[]
  otpRecords            OTP[]
  socialTaskCompletions SocialTaskCompletion[]

  @@unique([tenantId, phone])
  @@unique([tenantId, referralCode])
  @@index([tenantId, phone])
  @@index([tenantId, referralCode])
}

model Prize {
  id                  String   @id @default(cuid())
  tenantId            String?
  tenant              Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  campaignId          String
  campaign            Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  name                String
  description         String?
  imageUrl            String? // URL for prize image (can be from UploadThing or any image host)
  couponCode          String? // The actual coupon code to be sent
  probability         Float    @default(10.0) // Percentage (0-100)
  dailyLimit          Int      @default(100) // Max wins per day
  totalLimit          Int? // Total available (null = unlimited)
  currentStock        Int? // Current inventory stock (null = unlimited, only if plan allows)
  lowStockAlert       Int? // Alert threshold for low stock (null = disabled)
  isActive            Boolean  @default(true)
  showTryAgainMessage Boolean  @default(false) // If true, show "Sorry, try again in some time" when spinner lands on this prize
  colorCode           String   @default("#FFA500") // Hex color for wheel segment
  position            Int // Position on wheel (0-9)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  spins               Spin[]

  @@unique([campaignId, position])
  @@index([campaignId, isActive])
  @@index([tenantId])
}

model Spin {
  id              String   @id @default(cuid())
  userId          String
  user            EndUser  @relation(fields: [userId], references: [id], onDelete: Cascade)
  campaignId      String
  campaign        Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  prizeId         String?
  prize           Prize?   @relation(fields: [prizeId], references: [id], onDelete: SetNull)
  wonPrize        Boolean  @default(false)
  isReferralBonus Boolean  @default(false) // True if this spin was awarded via referral bonus
  spinDate        DateTime @default(now())
  ipAddress       String?
  userAgent       String?

  @@index([userId, campaignId, spinDate])
  @@index([spinDate])
  @@index([prizeId, spinDate])
  @@index([campaignId, spinDate])
}

model OTP {
  id        String   @id @default(cuid())
  userId    String?
  user      EndUser? @relation(fields: [userId], references: [id], onDelete: Cascade)
  phone     String
  otp       String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([phone, expiresAt, verified])
}

// Super Admin model (platform owner)
model Admin {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String // Hashed with bcrypt
  name         String
  isSuperAdmin Boolean  @default(false) // True for platform owner
  createdAt    DateTime @default(now())

  @@index([email])
  @@index([isSuperAdmin])
}

// Global settings (Super Admin managed)
model Setting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt

  @@index([key])
}

// ============================================
// SOCIAL MEDIA TASKS MODELS
// ============================================

model SocialMediaTask {
  id         String   @id @default(cuid())
  campaignId String
  campaign   Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  platform    String // FACEBOOK, INSTAGRAM, TWITTER, YOUTUBE
  actionType  String // VISIT_PAGE, VISIT_PROFILE, VIEW_POST, VIEW_DISCUSSION, VISIT_TO_SHARE, CONNECT_ACCOUNT
                     // @deprecated: LIKE_PAGE, LIKE_POST, FOLLOW, SHARE, COMMENT (use VISIT_* equivalents for policy compliance)
  title       String
  description String? // Optional extra context
  targetUrl   String // CRITICAL: The exact URL user must visit
  spinsReward Int // 1-10

  isActive     Boolean  @default(true)
  displayOrder Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  completions SocialTaskCompletion[]

  @@index([campaignId, isActive])
  @@index([platform])
}

model SocialTaskCompletion {
  id     String          @id @default(cuid())
  taskId String
  task   SocialMediaTask @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId String
  user   EndUser         @relation(fields: [userId], references: [id], onDelete: Cascade)

  status       String    @default("PENDING") // PENDING, VERIFIED, FAILED
  spinsAwarded Int
  
  // WhatsApp notification tracking
  notificationSent     Boolean   @default(false)
  notificationSentAt   DateTime?
  notificationDelivered Boolean  @default(false)
  
  // Adaptive verification tracking
  cohortId               String?  // For grouping completions by time window
  verificationStrategy    String?  // INDIVIDUAL, BATCHED, STATISTICAL, HONOR_SYSTEM
  sampledForVerification Boolean  @default(false)
  projectedFromSample    Boolean  @default(false)
  
  claimedAt    DateTime  @default(now())
  clickedAt    DateTime? // Server-side timestamp when user clicked "Visit" link
  verifiedAt   DateTime?

  @@unique([taskId, userId])
  @@index([userId, claimedAt])
  @@index([status])
  @@index([taskId])
  @@index([cohortId, status])
  @@index([claimedAt]) // For traffic detection
  @@index([clickedAt]) // For time-based verification
}

model SocialMediaCounter {
  id         String   @id @default(cuid())
  campaignId String?
  platform   String
  count      Int
  checkedAt  DateTime @default(now())

  @@index([campaignId, platform])
  @@index([platform, checkedAt])
}

// ============================================
// LANDING PAGE BUILDER MODELS
// ============================================

model LandingPage {
  id            String   @id @default(cuid())
  campaignId    String   @unique
  campaign      Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  
  title         String   // Landing page title (mandatory)
  template      String   @default("template_1") // template_1 through template_5
  brandColor    String   @default("#f59e0b") // Primary brand color
  backgroundColor String? // Optional background color/image
  metaTitle     String   // SEO title (mandatory)
  metaDescription String // SEO description (mandatory)
  
  isPublished   Boolean  @default(false)
  publishedAt   DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  sections      LandingPageSection[]
  offers        OfferShowcase[]
  footer        CampaignFooter?
  
  @@index([campaignId])
  @@index([isPublished])
}

model LandingPageSection {
  id            String   @id @default(cuid())
  landingPageId String
  landingPage   LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  
  type          String   // HERO, SOCIAL_TASKS, OFFERS, FOOTER, CUSTOM
  displayOrder  Int      @default(0)
  isVisible     Boolean  @default(true)
  
  // Flexible JSON content per section type
  content       Json     // Section-specific configuration
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([landingPageId, displayOrder])
  @@index([landingPageId, type])
}

model OfferShowcase {
  id            String   @id @default(cuid())
  landingPageId String
  landingPage   LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  
  offerType     String   // PRODUCT, SERVICE, DISCOUNT, VOUCHER, EXPERIENCE
  title         String
  description   String? // Full description (shown in modal)
  shortDescription String? // Brief description (shown in grid)
  image         String
  category      String?
  
  // Value information
  originalValue String? // "Worth ₹5,000"
  discountValue String? // "Get for ₹2,500" or "50% OFF"
  
  // External link
  externalLink  String?
  
  displayOrder  Int      @default(0)
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([landingPageId, displayOrder])
  @@index([landingPageId, offerType])
}

model CampaignFooter {
  id            String   @id @default(cuid())
  landingPageId String   @unique
  landingPage   LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
  
  // Brand information
  companyName   String
  companyTagline String?
  logoUrl       String?
  
  // Contact information
  supportEmail  String
  supportPhone  String?
  address       String?
  
  // Social media links
  facebookUrl   String?
  instagramUrl  String?
  twitterUrl    String?
  linkedinUrl   String?
  youtubeUrl    String?
  
  // Legal page URLs
  privacyPolicyUrl String  @default("/privacy")
  termsUrl         String  @default("/terms")
  rulesUrl         String  @default("/rules")
  disclaimerUrl    String?
  
  // Custom links (JSON array: [{label: "About", url: "/about"}])
  customLinks   Json?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// ============================================
// PLATFORM SETTINGS (Global Fallback)
// ============================================

model PlatformSettings {
  id                 String   @id @default("settings")
  facebookPageId     String?
  facebookToken      String?  @db.Text
  instagramAccountId String?
  instagramToken     String?  @db.Text
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}
