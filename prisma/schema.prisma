generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Plan {
  id                     String   @id @default(cuid())
  name                   String
  maxSpins               Int      @default(1000)
  maxCampaigns           Int      @default(1)
  campaignDurationDays   Int      @default(30)
  waIntegrationEnabled   Boolean  @default(true)
  canUseCustomTemplates  Boolean  @default(false)
  allowCustomDomain      Boolean  @default(false)
  allowEmbedding         Boolean  @default(false)
  allowAnalytics         Boolean  @default(false)
  allowQRCodeGenerator   Boolean  @default(false)
  allowInventoryTracking Boolean  @default(false)
  price                  Float?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  tenants                Tenant[]

  @@index([name])
}

model SubscriptionPlan {
  id                   String   @id @default(cuid())
  name                 String
  price                Int
  interval             String
  campaignsPerMonth    Int      @default(1)
  spinsPerCampaign     Int      @default(1000)
  campaignDurationDays Int      @default(30)
  spinsPerMonth        Int?     @default(5000)
  vouchersPerMonth     Int?     @default(2000)
  socialMediaEnabled   Boolean  @default(false)
  maxSocialTasks       Int      @default(0)
  customBranding       Boolean  @default(false)
  advancedAnalytics    Boolean  @default(false)
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  allowQRCodeGenerator Boolean  @default(false)
  tenants              Tenant[]

  @@index([name])
  @@index([isActive])
}

model WheelTemplate {
  id           String     @id @default(cuid())
  name         String
  thumbnail    String?
  configSchema Json
  componentKey String     @default("Classic")
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  campaigns    Campaign[]

  @@index([isActive])
}

model Tenant {
  id                 String                @id @default(cuid())
  name               String
  slug               String                @unique
  contactPhone       String?
  customDomain       String?               @unique
  planId             String
  subscriptionPlanId String?
  subscriptionStatus String                @default("TRIAL")
  subscriptionStart  DateTime?
  subscriptionEnd    DateTime?
  isActive           Boolean               @default(true)
  waConfig           Json?
  facebookPageId     String?
  facebookToken      String?
  instagramAccountId String?
  instagramToken     String?
  metaApiUsageHour   Int                   @default(0)
  lastApiUsageReset  DateTime              @default(now())
  isLocked           Boolean               @default(false)
  lockedAt           DateTime?
  lockedBy           String?
  failedLoginCount   Int                   @default(0)
  lastFailedLogin    DateTime?
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  campaigns          Campaign[]
  directSpinGrants   DirectSpinGrant[]
  endUsers           EndUser[]
  managers           Manager[]
  managerAuditLogs   ManagerAuditLog[]
  monthlyUsage       MonthlyUsage[]
  prizes             Prize[]
  securityEvents     SecurityEvent[]
  plan               Plan                  @relation(fields: [planId], references: [id])
  subscriptionPlan   SubscriptionPlan?     @relation(fields: [subscriptionPlanId], references: [id])
  tenantAdmins       TenantAdmin[]
  limitOverrides     TenantLimitOverride[]
  usage              TenantUsage[]
  vouchers           Voucher[]

  @@index([slug])
  @@index([isActive])
  @@index([subscriptionPlanId])
  @@index([subscriptionStatus])
}

model TenantAdmin {
  id               String    @id @default(cuid())
  tenantId         String
  email            String?   @unique
  password         String
  name             String
  createdAt        DateTime  @default(now())
  adminId          String?   @unique
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  redeemedVouchers Voucher[]

  @@index([tenantId, email])
  @@index([adminId])
}

model Manager {
  id                       String            @id @default(cuid())
  name                     String
  tenantId                 String
  pin                      String?
  maxBonusSpinsPerApproval Int               @default(10)
  maxSpinsPerUser          Int               @default(5)
  isActive                 Boolean           @default(true)
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt
  directSpinGrants         DirectSpinGrant[]
  tenant                   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  auditLogs                ManagerAuditLog[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

model ManagerAuditLog {
  id                String                @id @default(cuid())
  managerId         String
  tenantId          String
  action            String
  taskCompletionId  String?
  comment           String
  bonusSpinsGranted Int?
  createdAt         DateTime              @default(now())
  manager           Manager               @relation(fields: [managerId], references: [id], onDelete: Cascade)
  taskCompletion    SocialTaskCompletion? @relation(fields: [taskCompletionId], references: [id], onDelete: Cascade)
  tenant            Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([managerId])
  @@index([tenantId])
  @@index([taskCompletionId])
  @@index([createdAt])
}

model TenantUsage {
  id               String   @id @default(cuid())
  tenantId         String
  month            String
  campaignsCreated Int      @default(0)
  spinsUsed        Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, month])
  @@index([tenantId, month])
}

model Campaign {
  id                       String            @id @default(cuid())
  tenantId                 String
  templateId               String?
  name                     String
  description              String?
  logoUrl                  String?
  supportMobile            String?
  websiteUrl               String?
  isActive                 Boolean           @default(true)
  isArchived               Boolean           @default(false)
  archivedAt               DateTime?
  spinLimit                Int               @default(1)
  spinCooldown             Int               @default(24)
  referralsRequiredForSpin Int               @default(0)
  startDate                DateTime
  endDate                  DateTime
  createdAt                DateTime          @default(now())
  updatedAt                DateTime          @updatedAt
  referralsForBonus        Int               @default(5)
  referralBonusSpins       Int               @default(1)
  notificationEnabled      Boolean           @default(true)
  notificationStartHour    Int               @default(9)
  notificationEndHour      Int               @default(21)
  sendImmediately          Boolean           @default(false)
  socialMediaEnabled       Boolean           @default(false)
  defaultSpinRewards       Json?
  autoGenerateRules        Boolean           @default(true)
  rulesText                String?
  template                 WheelTemplate?    @relation(fields: [templateId], references: [id])
  tenant                   Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  landingPage              LandingPage?
  prizes                   Prize[]
  socialTasks              SocialMediaTask[]
  spins                    Spin[]

  @@index([tenantId, isActive, isArchived])
  @@index([isActive, startDate, endDate])
  @@index([isArchived])
}

model EndUser {
  id                    String                 @id @default(cuid())
  tenantId              String
  phone                 String
  name                  String?
  email                 String?
  referralCode          String                 @default(cuid())
  referredById          String?
  successfulReferrals   Int                    @default(0)
  sharedWins            Int                    @default(0)
  bonusSpinsEarned      Int                    @default(0)
  createdAt             DateTime               @default(now())
  directSpinGrants      DirectSpinGrant[]
  referredBy            EndUser?               @relation("UserReferrals", fields: [referredById], references: [id])
  referrals             EndUser[]              @relation("UserReferrals")
  tenant                Tenant                 @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  otpRecords            OTP[]
  socialTaskCompletions SocialTaskCompletion[]
  spins                 Spin[]
  vouchers              Voucher[]

  @@unique([tenantId, phone])
  @@unique([tenantId, referralCode])
  @@index([tenantId, phone])
  @@index([tenantId, referralCode])
}

model Prize {
  id                     String    @id @default(cuid())
  tenantId               String?
  campaignId             String
  name                   String
  description            String?
  imageUrl               String?
  couponCode             String?
  probability            Float     @default(10.0)
  dailyLimit             Int       @default(100)
  totalLimit             Int?
  currentStock           Int?
  lowStockAlert          Int?
  isActive               Boolean   @default(true)
  showTryAgainMessage    Boolean   @default(false)
  colorCode              String    @default("#FFA500")
  position               Int
  voucherValidityDays    Int       @default(30)
  voucherRedemptionLimit Int       @default(1)
  sendQRCode             Boolean   @default(true)
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  campaign               Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  tenant                 Tenant?   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  spins                  Spin[]
  vouchers               Voucher[]

  @@unique([campaignId, position])
  @@index([campaignId, isActive])
  @@index([tenantId])
}

model Spin {
  id              String    @id @default(cuid())
  userId          String
  campaignId      String
  prizeId         String?
  wonPrize        Boolean   @default(false)
  isReferralBonus Boolean   @default(false)
  spinDate        DateTime  @default(now())
  ipAddress       String?
  userAgent       String?
  campaign        Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  prize           Prize?    @relation(fields: [prizeId], references: [id])
  user            EndUser   @relation(fields: [userId], references: [id], onDelete: Cascade)
  vouchers        Voucher[]

  @@index([userId, campaignId, spinDate])
  @@index([spinDate])
  @@index([prizeId, spinDate])
  @@index([campaignId, spinDate])
}

model Voucher {
  id              String       @id @default(cuid())
  code            String       @unique
  qrImageUrl      String?
  spinId          String
  prizeId         String
  userId          String
  tenantId        String
  isRedeemed      Boolean      @default(false)
  redeemedAt      DateTime?
  redeemedBy      String?
  expiresAt       DateTime
  redemptionLimit Int          @default(1)
  redemptionCount Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  prize           Prize        @relation(fields: [prizeId], references: [id], onDelete: Cascade)
  redeemedByUser  TenantAdmin? @relation(fields: [redeemedBy], references: [id])
  spin            Spin         @relation(fields: [spinId], references: [id], onDelete: Cascade)
  tenant          Tenant       @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user            EndUser      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([tenantId])
  @@index([userId])
  @@index([expiresAt])
  @@index([isRedeemed])
  @@index([tenantId, userId])
  @@index([tenantId, isRedeemed])
}

model OTP {
  id        String   @id @default(cuid())
  userId    String?
  phone     String
  otp       String
  expiresAt DateTime
  verified  Boolean  @default(false)
  createdAt DateTime @default(now())
  user      EndUser? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phone, expiresAt, verified])
}

model Admin {
  id             String                @id @default(cuid())
  email          String                @unique
  password       String
  name           String
  isSuperAdmin   Boolean               @default(false)
  createdAt      DateTime              @default(now())
  auditLogs      AuditLog[]
  notifications  Notification[]
  limitOverrides TenantLimitOverride[]

  @@index([email])
  @@index([isSuperAdmin])
}

model Setting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedAt   DateTime @updatedAt

  @@index([key])
}

model SocialMediaTask {
  id           String                 @id @default(cuid())
  campaignId   String
  platform     String
  actionType   String
  title        String
  description  String?
  targetUrl    String
  spinsReward  Int
  isActive     Boolean                @default(true)
  displayOrder Int                    @default(0)
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  campaign     Campaign               @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  completions  SocialTaskCompletion[]

  @@index([campaignId, isActive])
  @@index([platform])
}

model SocialTaskCompletion {
  id                     String            @id @default(cuid())
  taskId                 String
  userId                 String
  status                 String            @default("PENDING")
  spinsAwarded           Int
  notificationSent       Boolean           @default(false)
  notificationSentAt     DateTime?
  notificationDelivered  Boolean           @default(false)
  cohortId               String?
  verificationStrategy   String?
  sampledForVerification Boolean           @default(false)
  projectedFromSample    Boolean           @default(false)
  claimedAt              DateTime          @default(now())
  clickedAt              DateTime?
  verifiedAt             DateTime?
  verificationComment    String?
  verifiedBy             String?
  managerAuditLogs       ManagerAuditLog[]
  task                   SocialMediaTask   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user                   EndUser           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([taskId, userId])
  @@index([userId, claimedAt])
  @@index([status])
  @@index([taskId])
  @@index([cohortId, status])
  @@index([claimedAt])
  @@index([clickedAt])
}

model DirectSpinGrant {
  id           String   @id @default(cuid())
  managerId    String
  userId       String
  tenantId     String
  spinsGranted Int      @default(1)
  comment      String?
  createdAt    DateTime @default(now())
  manager      Manager  @relation(fields: [managerId], references: [id], onDelete: Cascade)
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  user         EndUser  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([managerId, userId])
  @@index([userId])
  @@index([tenantId])
  @@index([createdAt])
}

model LandingPage {
  id              String               @id @default(cuid())
  campaignId      String               @unique
  title           String
  template        String               @default("template_1")
  brandColor      String               @default("#f59e0b")
  backgroundColor String?
  metaTitle       String
  metaDescription String
  isPublished     Boolean              @default(false)
  publishedAt     DateTime?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  footer          CampaignFooter?
  campaign        Campaign             @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sections        LandingPageSection[]
  offers          OfferShowcase[]

  @@index([campaignId])
  @@index([isPublished])
}

model LandingPageSection {
  id            String      @id @default(cuid())
  landingPageId String
  type          String
  displayOrder  Int         @default(0)
  isVisible     Boolean     @default(true)
  content       Json
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  landingPage   LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  @@index([landingPageId, displayOrder])
  @@index([landingPageId, type])
}

model OfferShowcase {
  id               String      @id @default(cuid())
  landingPageId    String
  offerType        String
  title            String
  description      String?
  shortDescription String?
  image            String
  category         String?
  originalValue    String?
  discountValue    String?
  externalLink     String?
  displayOrder     Int         @default(0)
  isActive         Boolean     @default(true)
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  landingPage      LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)

  @@index([landingPageId, displayOrder])
  @@index([landingPageId, offerType])
}

model CampaignFooter {
  id               String      @id @default(cuid())
  landingPageId    String      @unique
  companyName      String
  companyTagline   String?
  logoUrl          String?
  supportEmail     String
  supportPhone     String?
  address          String?
  facebookUrl      String?
  instagramUrl     String?
  twitterUrl       String?
  linkedinUrl      String?
  youtubeUrl       String?
  privacyPolicyUrl String      @default("/privacy")
  termsUrl         String      @default("/terms")
  rulesUrl         String      @default("/rules")
  disclaimerUrl    String?
  customLinks      Json?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt
  landingPage      LandingPage @relation(fields: [landingPageId], references: [id], onDelete: Cascade)
}

model MonthlyUsage {
  id           String   @id @default(cuid())
  tenantId     String
  month        Int
  year         Int
  spinsUsed    Int      @default(0)
  vouchersUsed Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, month, year])
  @@index([tenantId, year, month])
}

model TenantLimitOverride {
  id             String    @id @default(cuid())
  tenantId       String
  bonusSpins     Int       @default(0)
  bonusVouchers  Int       @default(0)
  reason         String
  grantedBy      String
  expiresAt      DateTime?
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  grantedByAdmin Admin     @relation(fields: [grantedBy], references: [id])
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, isActive])
  @@index([expiresAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  adminId    String
  action     String
  targetType String
  targetId   String
  changes    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  admin      Admin    @relation(fields: [adminId], references: [id])

  @@index([adminId, createdAt])
  @@index([targetType, targetId])
  @@index([action, createdAt])
  @@index([createdAt])
}

model Notification {
  id             String   @id @default(cuid())
  subject        String
  body           String
  recipientType  String
  recipientId    String?
  sentBy         String
  recipientCount Int      @default(0)
  sentAt         DateTime @default(now())
  sentByAdmin    Admin    @relation(fields: [sentBy], references: [id])

  @@index([sentBy, sentAt])
  @@index([recipientType, sentAt])
}

model SecurityEvent {
  id          String    @id @default(cuid())
  tenantId    String
  eventType   String
  severity    String
  description String
  metadata    Json?
  resolved    Boolean   @default(false)
  resolvedBy  String?
  resolvedAt  DateTime?
  createdAt   DateTime  @default(now())
  tenant      Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId, resolved])
  @@index([severity, resolved])
  @@index([createdAt])
}

model PlatformSettings {
  id                 String   @id @default("settings")
  facebookPageId     String?
  facebookToken      String?
  instagramAccountId String?
  instagramToken     String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}
