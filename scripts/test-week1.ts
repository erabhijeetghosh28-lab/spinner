import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function testWeek1() {
    console.log('üß™ Testing Week 1: Subscription System & Campaign Limits\n');

    // Test 1: Verify Subscription Plans exist
    console.log('1Ô∏è‚É£ Testing Subscription Plans...');
    const plans = await prisma.subscriptionPlan.findMany({
        orderBy: { price: 'asc' },
    });
    console.log(`   ‚úÖ Found ${plans.length} subscription plans:`);
    plans.forEach((plan) => {
        console.log(`      - ${plan.name}: ${plan.campaignsPerMonth} campaigns/month, ‚Çπ${plan.price / 100}/month`);
    });

    // Test 2: Verify Tenant has subscription plan
    console.log('\n2Ô∏è‚É£ Testing Tenant Subscription...');
    const tenant = await prisma.tenant.findFirst({
        include: {
            subscriptionPlan: true,
            plan: true,
            _count: {
                select: {
                    campaigns: {
                        where: {
                            isActive: true,
                            isArchived: false,
                        },
                    },
                },
            },
        },
    });

    if (tenant) {
        console.log(`   ‚úÖ Tenant: ${tenant.name}`);
        console.log(`      - Subscription Plan: ${tenant.subscriptionPlan?.name || 'None (using legacy plan)'}`);
        console.log(`      - Subscription Status: ${tenant.subscriptionStatus}`);
        console.log(`      - Active Campaigns: ${tenant._count.campaigns}`);
        if (tenant.subscriptionPlan) {
            console.log(`      - Campaign Limit: ${tenant.subscriptionPlan.campaignsPerMonth}/month`);
        }
    } else {
        console.log('   ‚ö†Ô∏è  No tenant found');
    }

    // Test 3: Verify TenantUsage tracking
    console.log('\n3Ô∏è‚É£ Testing Monthly Usage Tracking...');
    const now = new Date();
    const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    
    if (tenant) {
        const usage = await prisma.tenantUsage.findUnique({
            where: {
                tenantId_month: {
                    tenantId: tenant.id,
                    month: currentMonth,
                },
            },
        });

        if (usage) {
            console.log(`   ‚úÖ Monthly usage for ${currentMonth}:`);
            console.log(`      - Campaigns Created: ${usage.campaignsCreated}`);
            console.log(`      - Spins Used: ${usage.spinsUsed}`);
        } else {
            console.log(`   ‚ö†Ô∏è  No usage record for ${currentMonth} (will be created on first campaign creation)`);
        }
    }

    // Test 4: Verify Campaign soft delete fields
    console.log('\n4Ô∏è‚É£ Testing Campaign Soft Delete...');
    const campaigns = await prisma.campaign.findMany({
        take: 5,
        select: {
            id: true,
            name: true,
            isActive: true,
            isArchived: true,
            archivedAt: true,
        },
    });
    console.log(`   ‚úÖ Found ${campaigns.length} campaigns (showing first 5):`);
    campaigns.forEach((camp) => {
        const status = camp.isArchived
            ? 'ARCHIVED'
            : camp.isActive
            ? 'ACTIVE'
            : 'INACTIVE';
        console.log(`      - ${camp.name}: ${status}${camp.archivedAt ? ` (archived at ${camp.archivedAt.toISOString()})` : ''}`);
    });

    // Test 5: Check archived campaigns
    console.log('\n5Ô∏è‚É£ Testing Archived Campaigns...');
    const archivedCount = await prisma.campaign.count({
        where: { isArchived: true },
    });
    const activeCount = await prisma.campaign.count({
        where: { isActive: true, isArchived: false },
    });
    console.log(`   ‚úÖ Active Campaigns: ${activeCount}`);
    console.log(`   ‚úÖ Archived Campaigns: ${archivedCount}`);

    // Test 6: Verify limit calculation logic
    console.log('\n6Ô∏è‚É£ Testing Limit Calculation...');
    if (tenant && tenant.subscriptionPlan) {
        const activeLimit = tenant.subscriptionPlan.campaignsPerMonth;
        const monthlyLimit = tenant.subscriptionPlan.campaignsPerMonth;
        const activeCount = tenant._count.campaigns;
        
        const usage = await prisma.tenantUsage.findUnique({
            where: {
                tenantId_month: {
                    tenantId: tenant.id,
                    month: currentMonth,
                },
            },
        });
        const monthlyCount = usage?.campaignsCreated || 0;

        console.log(`   ‚úÖ Limit Check for ${tenant.name}:`);
        console.log(`      - Active: ${activeCount}/${activeLimit} (${activeCount < activeLimit ? '‚úÖ Can create' : '‚ùå Limit reached'})`);
        console.log(`      - Monthly: ${monthlyCount}/${monthlyLimit} (${monthlyCount < monthlyLimit ? '‚úÖ Can create' : '‚ùå Limit reached'})`);
        console.log(`      - Overall: ${activeCount < activeLimit && monthlyCount < monthlyLimit ? '‚úÖ CAN CREATE' : '‚ùå CANNOT CREATE'}`);
    }

    console.log('\n‚úÖ Week 1 Testing Complete!\n');
}

testWeek1()
    .catch((e) => {
        console.error('‚ùå Test failed:', e);
        process.exit(1);
    })
    .finally(async () => {
        await prisma.$disconnect();
    });
